name: Build ImmortalWrt

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      GITHUB_LINK: https://github.com/${{github.repository}}
      GIT_ACTOR: ${{github.actor}}
      GIT_REPOSITORY: ${{github.repository}}
      RUN_NUMBER: ${{github.run_number}}
      RUN_WORKFLOW: ${{github.workflow}}
      REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
      TZ: Asia/Shanghai
    
      PATH: ${{ secrets.PATH }}:$HOME/.cargo/bin:$PATH

    steps:

    - name: 密匙检测（密匙为空则退出）
      run: |
        cd ${GITHUB_WORKSPACE}
        if [[ -n "${{ env.REPO_TOKEN }}" ]]; then
          echo "密匙检测通过，继续执行"
        elif [[ -z "${{ env.REPO_TOKEN }}" ]]; then
          echo "您没有设置仓库密匙，请按教程设置好密匙再来"
          exit 1
        fi
    # 检出代码
    - name: Checkout code
      uses: actions/checkout@v3

    # 清理磁盘空间
    - name: Free up disk space
      run: |
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        df -h  

    # 安装必要的依赖
    - name: Install dependencies
      run: |
        chmod +x shells/ubuntu.sh
        ./shells/ubuntu.sh
        tar --version  # 验证 tar 是否安装成功
    # 启动 tmate 会话
    - name: Start tmate session
      run: |
        tmate -S /tmp/tmate.sock new-session -d
        tmate -S /tmp/tmate.sock wait tmate-ready
        echo "SSH connection: $(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')"
        echo "Web connection: $(tmate -S /tmp/tmate.sock display -p '#{tmate_web}')"



        

    # 设置 ImmortalWrt
    - name: Build ImmortalWrt
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git
        cd immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 输出 tmate 连接信息
    - name: Output tmate connection info
      run: |
        cd immortalwrt
        echo "SSH connection: $(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')"
        echo "Web connection: $(tmate -S /tmp/tmate.sock display -p '#{tmate_web}')"

    # 等待用户完成 tmate 会话
    - name: Wait for tmate session to complete
      run: |
        echo "Waiting for tmate session to complete. Please disconnect from the session to continue."
        tmate -S /tmp/tmate.sock wait tmate-exit

    # 编译 ImmortalWrt
    - name: Build ImmortalWrt
      run: |
        cd immortalwrt
        make -j1 V=s

    # 打包固件
    - name: Package firmware
      run: |
        cd immortalwrt/bin/targets
        tar -czf firmware.tar.gz *

    # 上传固件到 GitHub Releases
    - name: Upload firmware to GitHub Releases
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: immortalwrt/bin/targets/firmware.tar.gz
        asset_name: firmware.tar.gz
        asset_content_type: application/gzip